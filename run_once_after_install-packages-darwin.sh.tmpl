{{- if eq .chezmoi.os "darwin" -}}
#!/bin/bash

set -e # -e: exit on error

if [ ! "$(command -v brew)" ]; then
  echo "Installing brew"
  if [ "$(command -v curl)" ]; then
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  else
    echo "To install dotfiles, you must install curl." >&2
    exit 1
  fi
else
  chezmoi=chezmoi
fi



if [[ $CI ]]; then
  # CIでshh接続の鍵登録はしないので、httpsをそのまま使用する
  config=$(git config --global --get url.git@github.com:.insteadof)
  git config --global --unset url.git@github.com:.insteadof
  echo "Disabled ssh setting."
fi

brew bundle list --global --tap | xargs -n 1 brew tap
brew bundle --global list | xargs brew fetch --concurrency 16
brew bundle --global --no-lock --no-upgrade

if [[ $CI ]]; then
  git config --global url.git@github.com:.insteadof "${config}"
  echo "Recovered ssh setting."
fi

{{ end -}}
