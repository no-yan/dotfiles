#!/bin/zsh
# De-duplication
typeset -U PATH

# Setup package manager
if [[ "$(uname)" == "Darwin" ]]; then
  if [ -z "$(command -v brew)" ]; then
    brew_path=""
    for prefix in /opt/homebrew /usr/local; do
      if [ -x "$prefix/bin/brew" ]; then
        brew_path="$prefix/bin/brew"
        break
      fi
    done

    if [ -z "$brew_path" ]; then
      echo "Error: Homebrew not found. Please install Homebrew first." >&2
      exit 1
    fi

    eval "$($brew_path shellenv)"
  else
    [ -z "$HOMEBREW_PREFIX" ] && eval "$(brew shellenv)"
  fi
  export BREW_PREFIX=$HOMEBREW_PREFIX
else
  if [ -e "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
    . "$HOME/.nix-profile/etc/profile.d/nix.sh"
  fi
  export HOMEBREW_PREFIX="$HOME/.nix-profile"
  export BREW_PREFIX="$HOMEBREW_PREFIX"
fi


# ========================================
# Environment variable
# ========================================
addToPath() {
  export PATH="$1:$PATH"
}


export GOPATH=$HOME/go
export GODEBUG=asyncpreemptoff=1
export EDITOR=nvim

# AtCoder Library
export CPLUS_INCLUDE_PATH=$CPLUS_INCLUDE_PATH:$HOME/ghq/github.com/atcoder/ac-library

if [ -d ~/ghq/github.com/es-meta/esmeta ]; then
  export ESMETA_HOME=~/ghq/github.com/es-meta/esmeta
  addToPath "$ESMETA_HOME/bin"
fi

# pnpm
export PNPM_HOME="${HOME}/Library/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) addToPath "$PNPM_HOME" ;;
esac



# load zsh completion script stored in brew
# the built-in version of zsh doesnâ€™t know about by default.
if [ -n "$HOMEBREW_PREFIX" ]; then
  fpath=($HOMEBREW_PREFIX/share/zsh/site-functions $fpath)
fi

# gcloud
if [ -f "$HOME/google-cloud-sdk/path.zsh.inc" ]; then . "$HOME/google-cloud-sdk/path.zsh.inc"; fi

# ========================================
# PATH
# ========================================
# Brew
# Brew paths or nix profile
if [ -n "$HOMEBREW_PREFIX" ]; then
  [ -d "$HOMEBREW_PREFIX/sbin" ] && addToPath "$HOMEBREW_PREFIX/sbin"
  [ -d "$HOMEBREW_PREFIX/opt/llvm/bin" ] && addToPath "$HOMEBREW_PREFIX/opt/llvm/bin"
  [ -d "$HOMEBREW_PREFIX/opt/openjdk/bin" ] && addToPath "$HOMEBREW_PREFIX/opt/openjdk/bin"
  [ -d "$HOMEBREW_PREFIX/opt/curl/bin" ] && addToPath "$HOMEBREW_PREFIX/opt/curl/bin"
fi
# Go
addToPath "$GOPATH/bin"
# Standard ML
addToPath "/usr/local/smlnj/bin"
# Python package manager
addToPath "$HOME/.local/bin"
# Yarn
addToPath "$HOME/.yarn/bin"
# Aqua
addToPath "${AQUA_ROOT_DIR:-${XDG_DATA_HOME:-$HOME/.local/share}/aquaproj-aqua}/bin"
# Neovim
[ -d "/opt/nvim-linux-arm64/bin" ] && addToPath "/opt/nvim-linux-arm64/bin"

